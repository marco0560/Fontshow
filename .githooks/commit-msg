#!/usr/bin/env python3
import re
import sys

msg_file = sys.argv[1]

with open(msg_file, encoding="utf-8") as f:
    lines = f.read().splitlines()

if not lines:
    print("ERROR: commit message vuoto.")
    sys.exit(1)

first_line = lines[0].strip()

pattern = re.compile(
    r"^(feat|fix|docs|refactor|test|chore)"  # type
    r"(\([a-z0-9._-]+\))?"  # optional scope
    r"!?"  # optional breaking !
    r": "  # separator
    r".{1,72}$"  # summary length
)

if not pattern.match(first_line):
    print("ERROR: commit message non conforme.")
    print()
    print("Formato richiesto:")
    print("  type(scope): summary")
    print()
    print("Supporto BREAKING CHANGE:")
    print("  feat(core)!: summary")
    print("  oppure:")
    print("  feat(core): summary")
    print()
    print("  BREAKING CHANGE: description")
    sys.exit(1)

# Se presente, verifica sintattica minima del footer BREAKING CHANGE
for line in lines[1:]:
    if line.startswith("BREAKING CHANGE"):
        if not re.match(r"^BREAKING CHANGE: .+", line):
            print("ERROR: footer BREAKING CHANGE non valido.")
            print("Formato corretto:")
            print("  BREAKING CHANGE: description")
            sys.exit(1)

sys.exit(0)
