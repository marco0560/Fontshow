#!/usr/bin/env python3
import re
import sys

ALLOWED_TYPES = {
    "feat",
    "fix",
    "docs",
    "perf",
    "refactor",
    "test",
    "chore",
}
ALLOWED_SCOPES = {
    "core",
    "cli",
    "dev",
    "parser",
    "output",
    "config",
    "build",
    "dump",
    "catalog",
    "git",
    "release",
    "docs",
    "ci",
}

msg_file = sys.argv[1]

with open(msg_file, encoding="utf-8") as f:
    first_line = f.readline().strip()

pattern = re.compile(
    r"^(?P<type>feat|fix|docs|refactor|test|chore)"
    r"(\((?P<scope>[a-z0-9._-]+)\))?"
    r"(?P<breaking>!)?: "
    r".{1,72}$"
)

match = pattern.match(first_line)
if not match:
    print("ERROR: commit message non compliant.")
    print("Expected format:")
    print("  type(scope): summary")
    print("Types admitted:")
    for s in sorted(ALLOWED_TYPES):
        print(f"  - {s}")
    sys.exit(1)

scope = match.group("scope")
if scope and scope not in ALLOWED_SCOPES:
    print(f"ERROR: scope '{scope}' not admitted.")
    print("Scopes admitted:")
    for s in sorted(ALLOWED_SCOPES):
        print(f"  - {s}")
    sys.exit(1)
